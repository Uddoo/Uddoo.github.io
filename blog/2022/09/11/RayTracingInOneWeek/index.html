<!DOCTYPE html>
<html lang="zh-CN,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Ray Tracing in One Week 学习笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="Ray Tracing in One Week">
<meta property="og:url" content="http://example.com/blog/2022/09/11/RayTracingInOneWeek/index.html">
<meta property="og:site_name" content="2D Cat Studio">
<meta property="og:description" content="Ray Tracing in One Week 学习笔记">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/blog/2022/09/11/RayTracingInOneWeek/images/img-1.21-book1-final.jpg">
<meta property="article:published_time" content="2022-09-11T06:23:00.000Z">
<meta property="article:modified_time" content="2025-07-16T06:02:33.241Z">
<meta property="article:author" content="Uddoo">
<meta property="article:tag" content="计算机图形学">
<meta property="article:tag" content="光线追踪">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/blog/2022/09/11/RayTracingInOneWeek/images/img-1.21-book1-final.jpg">

<link rel="canonical" href="http://example.com/blog/2022/09/11/RayTracingInOneWeek/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Ray Tracing in One Week | 2D Cat Studio</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">2D Cat Studio</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">二维猫工作室</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">3</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">0</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">6</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/blog/2022/09/11/RayTracingInOneWeek/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Uddoo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="2D Cat Studio">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Ray Tracing in One Week
        </h1>

        <div class="post-meta">

          
            <i class="fa fa-thumb-tack"></i>
            <font color=7D26CD>置顶</font>
            <span class="post-meta-divider">|</span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-11 14:23:00" itemprop="dateCreated datePublished" datetime="2022-09-11T14:23:00+08:00">2022-09-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-07-16 14:02:33" itemprop="dateModified" datetime="2025-07-16T14:02:33+08:00">2025-07-16</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>25 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
            <img src="/images/img-1.21-book1-final.jpg" itemprop="contentUrl">
        </div>
        <h1 id="ray-tracing-in-one-week系列笔记"><a class="markdownIt-Anchor" href="#ray-tracing-in-one-week系列笔记"></a> Ray Tracing in One Week系列笔记</h1>
<h2 id="chapter-1~2-output-an-image-and-vec3"><a class="markdownIt-Anchor" href="#chapter-1~2-output-an-image-and-vec3"></a> Chapter 1~2 : Output an image and Vec3</h2>
<p>输出到PPM图片文件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vec3.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="type">int</span> nx = <span class="number">200</span>;</span><br><span class="line">	<span class="type">int</span> ny = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 以写模式打开文件</span></span><br><span class="line">	std::ofstream outfile;</span><br><span class="line">	outfile.<span class="built_in">open</span>(<span class="string">&quot;color.ppm&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PPM格式，P3表示颜色以ASCII表示，200行，100列，最大颜色数量255</span></span><br><span class="line">	outfile &lt;&lt; <span class="string">&quot;P3\n&quot;</span> &lt;&lt; nx &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ny &lt;&lt; <span class="string">&quot;\n255\n&quot;</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> j = ny - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nx; i++) &#123;</span><br><span class="line">			<span class="function">vec3 <span class="title">col</span><span class="params">(<span class="type">float</span>(i) / <span class="type">float</span>(nx), <span class="type">float</span>(j) / <span class="type">float</span>(ny), <span class="number">0.2</span>)</span></span>;</span><br><span class="line">			<span class="comment">// 将（0，1）扩张到（0，255.99）</span></span><br><span class="line">			<span class="type">int</span> ir = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">0</span>]);</span><br><span class="line">			<span class="type">int</span> ig = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">1</span>]);</span><br><span class="line">			<span class="type">int</span> ib = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">2</span>]);</span><br><span class="line">			outfile &lt;&lt; ir &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ig &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ib &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	outfile.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<p><img src="/.com//image-20220912173008874.png" alt="image-20220912173008874"></p>
<h2 id="chapter-3-rays-a-simple-camera-and-background"><a class="markdownIt-Anchor" href="#chapter-3-rays-a-simple-camera-and-background"></a> Chapter 3 ：Rays, a simple camera, and background</h2>
<h3 id="射线的构建"><a class="markdownIt-Anchor" href="#射线的构建"></a> 射线的构建</h3>
<p>所有的Ray Trace都以Ray类为基础，光线追踪器的核心是发送光线穿过像素，并计算在这些光线的方向上看到什么颜色。<br>
它的形式是计算光线从眼睛到一个像素，计算该光线的相交，并计算出该交点的颜色。</p>
<p><img src="/.com//image-20220912174316734.png" alt="image-20220912174316734"></p>
<p>一条射线的表示方式：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><mi>A</mi><mo>+</mo><mi>t</mi><mo>∗</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">p(t) = A + t * B
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span></p>
<p>因此ray类如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by yw_li on 2022/9/12.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> RAYTRACINGTOY_RAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RAYTRACINGTOY_RAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vec3.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ray</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">ray</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/// 声明一条射线</span></span><br><span class="line">	<span class="comment">/// \param a 射线起点</span></span><br><span class="line">	<span class="comment">/// \param b 射线终点</span></span><br><span class="line">	<span class="built_in">ray</span>(<span class="type">const</span> vec3 &amp;a, <span class="type">const</span> vec3 &amp;b) &#123;</span><br><span class="line">		A = a;</span><br><span class="line">		B = b;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/// 返回射线起点</span></span><br><span class="line">	<span class="comment">/// \return 射线起点</span></span><br><span class="line">	<span class="function">vec3 <span class="title">origin</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> A; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/// 返回射线的指向</span></span><br><span class="line">	<span class="comment">/// \return 射线的指向</span></span><br><span class="line">	<span class="function">vec3 <span class="title">direction</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> B; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/// 返回射线上某一点</span></span><br><span class="line">	<span class="comment">/// \param t</span></span><br><span class="line">	<span class="comment">/// \return</span></span><br><span class="line">	<span class="function">vec3 <span class="title">point_at_parameter</span><span class="params">(<span class="type">float</span> t)</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> A + B * t; &#125;</span><br><span class="line"></span><br><span class="line">	vec3 A;</span><br><span class="line">	vec3 B;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//RAYTRACINGTOY_RAY_H</span></span></span><br></pre></td></tr></table></figure>
<p>构建一个视角，摄像机或眼睛放在原点</p>
<p><img src="/.com//image-20220912192140976.png" alt="image-20220912192140976"></p>
<p>线性插值lerp：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>b</mi><mi>l</mi><mi>e</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mtext>）</mtext><mo>∗</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>+</mo><mi>t</mi><mo>∗</mo><mi>e</mi><mi>n</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">blended\_value = (1-t）*start\_value + t*end\_value
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord cjk_fallback">）</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span></span></span></span></span></p>
<p>利用ray去计算指向点的颜色，修改过的main.cpp如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vec3.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ray.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// color(ray)函数根据Y坐标的上/下限线性地混合白色和蓝色。</span></span><br><span class="line"><span class="comment">/// \param r 射线</span></span><br><span class="line"><span class="comment">/// \return 返回射线所指向的点的颜色</span></span><br><span class="line"><span class="function">vec3 <span class="title">color</span><span class="params">(<span class="type">const</span> ray &amp;r)</span> </span>&#123;</span><br><span class="line">	vec3 unit_direction = <span class="built_in">unit_vector</span>(r.<span class="built_in">direction</span>()); <span class="comment">// 射线的单位方向向量</span></span><br><span class="line">	<span class="type">float</span> t = <span class="number">0.5</span> * (unit_direction.<span class="built_in">y</span>() + <span class="number">1.0</span>);</span><br><span class="line">	<span class="comment">// 返回混合后的值</span></span><br><span class="line">	<span class="comment">// vec3(1.0, 1.0, 1.0)是白色，vec3(0.5, 0.7, 1.0f)是蓝色</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="number">1.0f</span> - t) * <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>) + t * <span class="built_in">vec3</span>(<span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="type">int</span> nx = <span class="number">200</span>;</span><br><span class="line">	<span class="type">int</span> ny = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 以写模式打开文件</span></span><br><span class="line">	std::ofstream outfile;</span><br><span class="line">	outfile.<span class="built_in">open</span>(<span class="string">&quot;color.ppm&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PPM格式，P3表示颜色以ASCII表示，200行，100列，最大颜色数量255</span></span><br><span class="line">	outfile &lt;&lt; <span class="string">&quot;P3\n&quot;</span> &lt;&lt; nx &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ny &lt;&lt; <span class="string">&quot;\n255\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">vec3 <span class="title">lower_left_corner</span><span class="params">(<span class="number">-2.0</span>, <span class="number">-1.0</span>, <span class="number">-1.0</span>)</span></span>; <span class="comment">// 定义左下角</span></span><br><span class="line">	<span class="function">vec3 <span class="title">horizontal</span><span class="params">(<span class="number">4.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>)</span></span>; <span class="comment">// x轴向右，最大为4</span></span><br><span class="line">	<span class="function">vec3 <span class="title">vertical</span><span class="params">(<span class="number">0.0</span>, <span class="number">2.0</span>, <span class="number">0.0</span>)</span></span>; <span class="comment">// y轴向上，最高为2</span></span><br><span class="line">	<span class="function">vec3 <span class="title">origin</span><span class="params">(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>)</span></span>; <span class="comment">// 摄像机在坐标原点</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> j = ny - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nx; i++) &#123;</span><br><span class="line">			<span class="type">float</span> u = <span class="built_in">float</span>(i) / <span class="built_in">float</span>(nx);</span><br><span class="line">			<span class="type">float</span> v = <span class="built_in">float</span>(j) / <span class="built_in">float</span>(ny);</span><br><span class="line"></span><br><span class="line">			<span class="function">ray <span class="title">r</span><span class="params">(origin, lower_left_corner + u * horizontal + v * vertical)</span></span>;</span><br><span class="line">			vec3 col = <span class="built_in">color</span>(r);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 将（0，1）映射到（0，255.99）</span></span><br><span class="line">			<span class="type">int</span> ir = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">0</span>]);</span><br><span class="line">			<span class="type">int</span> ig = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">1</span>]);</span><br><span class="line">			<span class="type">int</span> ib = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">2</span>]);</span><br><span class="line">			outfile &lt;&lt; ir &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ig &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ib &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	outfile.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出的结果：</p>
<p><img src="/.com//image-20220912192114174.png" alt="image-20220912192114174"></p>
<h2 id="chapter-4-adding-a-sphere"><a class="markdownIt-Anchor" href="#chapter-4-adding-a-sphere"></a> Chapter 4 ：Adding a sphere</h2>
<p>球心在原点，且半径为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span>的球体可以表示为：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>x</mi><mo>∗</mo><mi>x</mi><mo>+</mo><mi>y</mi><mo>∗</mo><mi>y</mi><mo>+</mo><mi>z</mi><mo>∗</mo><mi>z</mi><mo>=</mo><mi>R</mi><mo>∗</mo><mi>R</mi></mrow><annotation encoding="application/x-tex">x*x + y * y + z*z = R * R
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.46528em;vertical-align:0em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.6597200000000001em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.46528em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></span></p>
<p>球心在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>c</mi><mi>x</mi><mo separator="true">,</mo><mi>c</mi><mi>y</mi><mo separator="true">,</mo><mi>c</mi><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(cx,cy,cz)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span>，半径为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span>的球体可以表示为：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mi>x</mi><mo>−</mo><mi>c</mi><mi>x</mi><mo stretchy="false">)</mo><mo>∗</mo><mo stretchy="false">(</mo><mi>x</mi><mo>−</mo><mi>c</mi><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mi>y</mi><mo>−</mo><mi>c</mi><mi>y</mi><mo stretchy="false">)</mo><mo>∗</mo><mo stretchy="false">(</mo><mi>y</mi><mo>−</mo><mi>c</mi><mi>y</mi><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mi>z</mi><mo>−</mo><mi>c</mi><mi>z</mi><mo stretchy="false">)</mo><mo>∗</mo><mo stretchy="false">(</mo><mi>z</mi><mo>−</mo><mi>c</mi><mi>z</mi><mo stretchy="false">)</mo><mo>=</mo><mi>R</mi><mo>∗</mo><mi>R</mi></mrow><annotation encoding="application/x-tex">(x - cx)*(x - cx) + (y - cy) * (y - cy) + (z - cz)*(z - cz) = R*R
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></span></p>
<p>当球心表示为</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>C</mi><mo>=</mo><mo stretchy="false">(</mo><mi>c</mi><mi>x</mi><mo separator="true">,</mo><mi>c</mi><mi>y</mi><mo separator="true">,</mo><mi>c</mi><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C = (cx,cy,cz)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span></span></p>
<p>球体上任一点表示为</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>p</mi><mo>=</mo><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p = (x,y,z)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span></span></p>
<p>而<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span>指向<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span></span></span></span>是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>p</mi><mo>−</mo><mi>C</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(p-C)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)</span></span></span></span>，因此</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>d</mi><mi>o</mi><mi>t</mi><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mi>p</mi><mo>−</mo><mi>C</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>p</mi><mo>−</mo><mi>C</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mi>x</mi><mo>−</mo><mi>c</mi><mi>x</mi><mo stretchy="false">)</mo><mo>∗</mo><mo stretchy="false">(</mo><mi>x</mi><mo>−</mo><mi>c</mi><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mi>y</mi><mo>−</mo><mi>c</mi><mi>y</mi><mo stretchy="false">)</mo><mo>∗</mo><mo stretchy="false">(</mo><mi>y</mi><mo>−</mo><mi>c</mi><mi>y</mi><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mi>z</mi><mo>−</mo><mi>c</mi><mi>z</mi><mo stretchy="false">)</mo><mo>∗</mo><mo stretchy="false">(</mo><mi>z</mi><mo>−</mo><mi>c</mi><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">dot((p-C),(p-C)) = (x - cx)*(x - cx) + (y - cy) * (y - cy) + (z - cz)*(z - cz)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span></span></p>
<p>即球体方程可以表示为：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>d</mi><mi>o</mi><mi>t</mi><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mi>p</mi><mo>−</mo><mi>C</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>p</mi><mo>−</mo><mi>C</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>=</mo><mi>R</mi><mo>∗</mo><mi>R</mi></mrow><annotation encoding="application/x-tex">dot((p-C),(p-C)) = R*R
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></span></p>
<p>等价于：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>d</mi><mi>o</mi><mi>t</mi><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mi>A</mi><mo>+</mo><mi>t</mi><mo>∗</mo><mi>B</mi><mo>−</mo><mi>C</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>A</mi><mo>+</mo><mi>t</mi><mo>∗</mo><mi>B</mi><mo>−</mo><mi>C</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>=</mo><mi>R</mi><mo>∗</mo><mi>R</mi></mrow><annotation encoding="application/x-tex">dot((A + t*B - C),(A + t*B - C)) = R*R
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></span></p>
<p>展开可以得到：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>t</mi><mo>∗</mo><mi>t</mi><mo>∗</mo><mi>d</mi><mi>o</mi><mi>t</mi><mo stretchy="false">(</mo><mi>B</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo><mo>+</mo><mn>2</mn><mo>∗</mo><mi>t</mi><mo>∗</mo><mi>d</mi><mi>o</mi><mi>t</mi><mo stretchy="false">(</mo><mi>A</mi><mo>−</mo><mi>C</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo><mo>+</mo><mi>d</mi><mi>o</mi><mi>t</mi><mo stretchy="false">(</mo><mi>A</mi><mo>−</mo><mi>C</mi><mo separator="true">,</mo><mi>A</mi><mo>−</mo><mi>C</mi><mo stretchy="false">)</mo><mo>−</mo><mi>R</mi><mo>∗</mo><mi>R</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">t*t*dot(B,B) + 2*t*dot(A-C,B) + dot(A-C,A-C) - R*R = 0
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo separator="true">,</mo><mi>C</mi><mo separator="true">,</mo><mi>R</mi></mrow><annotation encoding="application/x-tex">A,B,C,R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span>均为已知量，因此得到关于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span>的一元二次方程，关于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span>的解的数量，有如下关系：</p>
<p><img src="/.com//image-20220912195109354.png" alt="image-20220912195109354"></p>
<p>对是否相交进行判断，并修改color函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 检测射线是否与球心为center，半径为radius的球相交</span></span><br><span class="line"><span class="comment">/// \param center 球心</span></span><br><span class="line"><span class="comment">/// \param radius 半径</span></span><br><span class="line"><span class="comment">/// \param r 射线</span></span><br><span class="line"><span class="comment">/// \return 是否相交</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">hit_sphere</span><span class="params">(<span class="type">const</span> vec3 &amp;center, <span class="type">float</span> radius, <span class="type">const</span> ray &amp;r)</span> </span>&#123;</span><br><span class="line">	vec3 oc = r.<span class="built_in">origin</span>() - center;</span><br><span class="line">	<span class="type">float</span> a = <span class="built_in">dot</span>(r.<span class="built_in">direction</span>(), r.<span class="built_in">direction</span>()); <span class="comment">// 一元二次方程系数a</span></span><br><span class="line">	<span class="type">float</span> b = <span class="number">2.0</span> * <span class="built_in">dot</span>(oc, r.<span class="built_in">direction</span>());</span><br><span class="line">	<span class="type">float</span> c = <span class="built_in">dot</span>(oc, oc) - radius * radius;</span><br><span class="line">	<span class="type">float</span> discriminant = b * b - <span class="number">4</span> * a * c;</span><br><span class="line">	<span class="keyword">return</span> (discriminant &gt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// color(ray)函数根据Y坐标的上/下限线性地混合白色和蓝色。</span></span><br><span class="line"><span class="comment">/// \param r 射线</span></span><br><span class="line"><span class="comment">/// \return 返回射线所指向的点的颜色</span></span><br><span class="line"><span class="function">vec3 <span class="title">color</span><span class="params">(<span class="type">const</span> ray &amp;r)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">hit_sphere</span>(<span class="built_in">vec3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">-1</span>), <span class="number">0.5</span>, r)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">vec3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">// 如果射线与球心为(0,0,-1)，半径为0.5的球相交，则返回红色</span></span><br><span class="line">	&#125;</span><br><span class="line">	vec3 unit_direction = <span class="built_in">unit_vector</span>(r.<span class="built_in">direction</span>()); <span class="comment">// 射线的单位方向向量</span></span><br><span class="line">	<span class="type">float</span> t = <span class="number">0.5</span> * (unit_direction.<span class="built_in">y</span>() + <span class="number">1.0</span>);</span><br><span class="line">	<span class="comment">// 返回混合后的值</span></span><br><span class="line">	<span class="comment">// vec3(1.0, 1.0, 1.0)是白色，vec3(0.5, 0.7, 1.0f)是蓝色</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="number">1.0f</span> - t) * <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>) + t * <span class="built_in">vec3</span>(<span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最终输出结果如下：</p>
<p><img src="/.com//image-20220912201155670.png" alt="image-20220912201155670"></p>
<p>修改后的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>a</mi><mi>i</mi><mi>n</mi><mi mathvariant="normal">.</mi><mi>c</mi><mi>p</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">main.cpp</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">a</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord">.</span><span class="mord mathnormal">c</span><span class="mord mathnormal">p</span><span class="mord mathnormal">p</span></span></span></span>如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vec3.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ray.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 检测射线是否与球心为center，半径为radius的球相交</span></span><br><span class="line"><span class="comment">/// \param center 球心</span></span><br><span class="line"><span class="comment">/// \param radius 半径</span></span><br><span class="line"><span class="comment">/// \param r 射线</span></span><br><span class="line"><span class="comment">/// \return 是否相交</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">hit_sphere</span><span class="params">(<span class="type">const</span> vec3 &amp;center, <span class="type">float</span> radius, <span class="type">const</span> ray &amp;r)</span> </span>&#123;</span><br><span class="line">	vec3 oc = r.<span class="built_in">origin</span>() - center;</span><br><span class="line">	<span class="type">float</span> a = <span class="built_in">dot</span>(r.<span class="built_in">direction</span>(), r.<span class="built_in">direction</span>()); <span class="comment">// 一元二次方程系数a</span></span><br><span class="line">	<span class="type">float</span> b = <span class="number">2.0</span> * <span class="built_in">dot</span>(oc, r.<span class="built_in">direction</span>());</span><br><span class="line">	<span class="type">float</span> c = <span class="built_in">dot</span>(oc, oc) - radius * radius;</span><br><span class="line">	<span class="type">float</span> discriminant = b * b - <span class="number">4</span> * a * c;</span><br><span class="line">	<span class="keyword">return</span> (discriminant &gt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// color(ray)函数根据Y坐标的上/下限线性地混合白色和蓝色。</span></span><br><span class="line"><span class="comment">/// \param r 射线</span></span><br><span class="line"><span class="comment">/// \return 返回射线所指向的点的颜色</span></span><br><span class="line"><span class="function">vec3 <span class="title">color</span><span class="params">(<span class="type">const</span> ray &amp;r)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">hit_sphere</span>(<span class="built_in">vec3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">-1</span>), <span class="number">0.5</span>, r)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">vec3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">// 如果射线与球心为(0,0,-1)，半径为0.5的球相交，则返回红色</span></span><br><span class="line">	&#125;</span><br><span class="line">	vec3 unit_direction = <span class="built_in">unit_vector</span>(r.<span class="built_in">direction</span>()); <span class="comment">// 射线的单位方向向量</span></span><br><span class="line">	<span class="type">float</span> t = <span class="number">0.5</span> * (unit_direction.<span class="built_in">y</span>() + <span class="number">1.0</span>);</span><br><span class="line">	<span class="comment">// 返回混合后的值</span></span><br><span class="line">	<span class="comment">// vec3(1.0, 1.0, 1.0)是白色，vec3(0.5, 0.7, 1.0f)是蓝色</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="number">1.0f</span> - t) * <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>) + t * <span class="built_in">vec3</span>(<span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="type">int</span> nx = <span class="number">200</span>;</span><br><span class="line">	<span class="type">int</span> ny = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 以写模式打开文件</span></span><br><span class="line">	std::ofstream outfile;</span><br><span class="line">	outfile.<span class="built_in">open</span>(<span class="string">&quot;color.ppm&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PPM格式，P3表示颜色以ASCII表示，200行，100列，最大颜色数量255</span></span><br><span class="line">	outfile &lt;&lt; <span class="string">&quot;P3\n&quot;</span> &lt;&lt; nx &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ny &lt;&lt; <span class="string">&quot;\n255\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">vec3 <span class="title">lower_left_corner</span><span class="params">(<span class="number">-2.0</span>, <span class="number">-1.0</span>, <span class="number">-1.0</span>)</span></span>; <span class="comment">// 定义左下角</span></span><br><span class="line">	<span class="function">vec3 <span class="title">horizontal</span><span class="params">(<span class="number">4.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>)</span></span>; <span class="comment">// x轴向右，最大为4</span></span><br><span class="line">	<span class="function">vec3 <span class="title">vertical</span><span class="params">(<span class="number">0.0</span>, <span class="number">2.0</span>, <span class="number">0.0</span>)</span></span>; <span class="comment">// y轴向上，最高为2</span></span><br><span class="line">	<span class="function">vec3 <span class="title">origin</span><span class="params">(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>)</span></span>; <span class="comment">// 摄像机在坐标原点</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> j = ny - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nx; i++) &#123;</span><br><span class="line">			<span class="type">float</span> u = <span class="built_in">float</span>(i) / <span class="built_in">float</span>(nx);</span><br><span class="line">			<span class="type">float</span> v = <span class="built_in">float</span>(j) / <span class="built_in">float</span>(ny);</span><br><span class="line"></span><br><span class="line">			<span class="function">ray <span class="title">r</span><span class="params">(origin, lower_left_corner + u * horizontal + v * vertical)</span></span>;</span><br><span class="line">			vec3 col = <span class="built_in">color</span>(r);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 将（0，1）映射到（0，255.99）</span></span><br><span class="line">			<span class="type">int</span> ir = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">0</span>]);</span><br><span class="line">			<span class="type">int</span> ig = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">1</span>]);</span><br><span class="line">			<span class="type">int</span> ib = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">2</span>]);</span><br><span class="line">			outfile &lt;&lt; ir &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ig &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ib &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	outfile.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="chapter-5-surface-normals-and-multiple-objects"><a class="markdownIt-Anchor" href="#chapter-5-surface-normals-and-multiple-objects"></a> Chapter 5 : Surface normals and multiple objects</h2>
<p>球体的表面的法线向量：由球心指向接触点</p>
<p><img src="/.com//image-20220912223950476.png" alt="image-20220912223950476"></p>
<p>我们先求得交点处的法线单位向量<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>，再将其映射到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0,1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 检测射线是否与球心为center，半径为radius的球相交</span></span><br><span class="line"><span class="comment">/// \param center 球心</span></span><br><span class="line"><span class="comment">/// \param radius 半径</span></span><br><span class="line"><span class="comment">/// \param r 射线</span></span><br><span class="line"><span class="comment">/// \return 是否相交</span></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">hit_sphere</span><span class="params">(<span class="type">const</span> vec3 &amp;center, <span class="type">float</span> radius, <span class="type">const</span> ray &amp;r)</span> </span>&#123;</span><br><span class="line">	vec3 oc = r.<span class="built_in">origin</span>() - center;</span><br><span class="line">	<span class="type">float</span> a = <span class="built_in">dot</span>(r.<span class="built_in">direction</span>(), r.<span class="built_in">direction</span>()); <span class="comment">// 一元二次方程系数a</span></span><br><span class="line">	<span class="type">float</span> b = <span class="number">2.0</span> * <span class="built_in">dot</span>(oc, r.<span class="built_in">direction</span>());</span><br><span class="line">	<span class="type">float</span> c = <span class="built_in">dot</span>(oc, oc) - radius * radius;</span><br><span class="line">	<span class="type">float</span> discriminant = b * b - <span class="number">4</span> * a * c;</span><br><span class="line">	<span class="keyword">if</span> (discriminant &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1.0</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// 一元二次方程的两个解中较小的那个，即先发生碰撞的点</span></span><br><span class="line">		<span class="built_in">return</span> (-b - <span class="built_in">sqrt</span>(discriminant) / (<span class="number">2.0</span> * a));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// color(ray)函数根据Y坐标的上/下限线性地混合白色和蓝色。</span></span><br><span class="line"><span class="comment">/// \param r 射线</span></span><br><span class="line"><span class="comment">/// \return 返回射线所指向的点的颜色</span></span><br><span class="line"><span class="function">vec3 <span class="title">color</span><span class="params">(<span class="type">const</span> ray &amp;r)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 求得射线与球发生相交时的第一个点对应的t</span></span><br><span class="line">	<span class="type">float</span> t = <span class="built_in">hit_sphere</span>(<span class="built_in">vec3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">-1</span>), <span class="number">0.5</span>, r);</span><br><span class="line">	<span class="keyword">if</span> (t &gt; <span class="number">0.0</span>) &#123;</span><br><span class="line">		<span class="comment">// 求得球心指向交点的法线单位向量</span></span><br><span class="line">		vec3 N = <span class="built_in">unit_vector</span>(r.<span class="built_in">point_at_parameter</span>(t) - <span class="built_in">vec3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">-1</span>));</span><br><span class="line">		<span class="comment">// 将求得的法线单位向量由[-1,1]映射到[0,1]</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0.5</span> * <span class="built_in">vec3</span>(N.<span class="built_in">x</span>() + <span class="number">1</span>, N.<span class="built_in">y</span>() + <span class="number">1</span>, N.<span class="built_in">z</span>() + <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	vec3 unit_direction = <span class="built_in">unit_vector</span>(r.<span class="built_in">direction</span>()); <span class="comment">// 射线的单位方向向量</span></span><br><span class="line">	t = <span class="number">0.5</span> * (unit_direction.<span class="built_in">y</span>() + <span class="number">1.0</span>);</span><br><span class="line">	<span class="comment">// 返回混合后的值</span></span><br><span class="line">	<span class="comment">// vec3(1.0, 1.0, 1.0)是白色，vec3(0.5, 0.7, 1.0f)是蓝色</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="number">1.0f</span> - t) * <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>) + t * <span class="built_in">vec3</span>(<span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果如下：</p>
<p><img src="/.com//image-20220913193437991.png" alt="image-20220913193437991"></p>
<p>现在考虑多个可被击中的物体。</p>
<p>构建一个Hitable的抽象类，包含抽象方法hit判断是否击中物体，以及记录hit到的数据，包括hit的位置，hit点的法向，以及距离参数t。</p>
<p>设定<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span>的区间<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>m</mi><mi>i</mi><mi>n</mi><mo>&lt;</mo><mi>t</mi><mo>&lt;</mo><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">tmin &lt; t &lt; tmax</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69862em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">m</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.65418em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">m</span><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span></span></span></span>，可以控制在此区域内的hit才计数。在计算hit时，只需要最接近的事物的法线。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by yw_li on 2022/9/13.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> RAYTRACINGTOY_HITABLE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RAYTRACINGTOY_HITABLE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ray.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">hit_record</span> &#123;</span><br><span class="line">	<span class="type">float</span> t; <span class="comment">// 射线参数t</span></span><br><span class="line">	vec3 p; <span class="comment">// 射线与物体的交点（碰撞点）</span></span><br><span class="line">	vec3 normal; <span class="comment">// 碰撞点处的法线向量</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">hitable</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">hit</span><span class="params">(<span class="type">const</span> ray &amp;r, <span class="type">float</span> t_min, <span class="type">float</span> t_max, hit_record &amp;rec)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//RAYTRACINGTOY_HITABLE_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>对于sphere类基础hitable抽象类，实现自己的hit方法，去判断是否击中了球的对象</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by yw_li on 2022/9/13.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> RAYTRACINGTOY_SPHERE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RAYTRACINGTOY_SPHERE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hitable.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">sphere</span> : <span class="keyword">public</span> hitable &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">sphere</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 构造球心为cen，半径为r的球体</span></span><br><span class="line">	<span class="built_in">sphere</span>(vec3 cen, <span class="type">float</span> r) : <span class="built_in">center</span>(cen), <span class="built_in">radius</span>(r) &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">hit</span><span class="params">(<span class="type">const</span> ray &amp;r, <span class="type">float</span> tmin, <span class="type">float</span> tmax, hit_record &amp;rec)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">	vec3 center; <span class="comment">// 球心坐标</span></span><br><span class="line">	<span class="type">float</span> radius; <span class="comment">// 球体半径</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">sphere::hit</span><span class="params">(<span class="type">const</span> ray &amp;r, <span class="type">float</span> tmin, <span class="type">float</span> tmax, hit_record &amp;rec)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">	vec3 oc = r.<span class="built_in">origin</span>() - center;</span><br><span class="line">	<span class="type">float</span> a = <span class="built_in">dot</span>(r.<span class="built_in">direction</span>(), r.<span class="built_in">direction</span>());</span><br><span class="line">	<span class="type">float</span> b = <span class="built_in">dot</span>(oc, r.<span class="built_in">direction</span>());</span><br><span class="line">	<span class="type">float</span> c = <span class="built_in">dot</span>(oc, oc) - radius * radius;</span><br><span class="line">	<span class="type">float</span> discriminant = b * b - a * c;</span><br><span class="line">	<span class="keyword">if</span> (discriminant &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">// 射线与球体相交时，找出参数t处于[tmin,tmax]范围内的交点</span></span><br><span class="line">		<span class="comment">// 两个交点都在范围内的话，返回参数t较小的那个（即先碰撞的点）</span></span><br><span class="line">		<span class="comment">// 将碰撞点信息存储rec中</span></span><br><span class="line">		<span class="type">float</span> temp = (-b - <span class="built_in">sqrt</span>(b * b - a * c)) / a;</span><br><span class="line">		<span class="keyword">if</span> (temp &lt; tmax &amp;&amp; temp &gt; tmin) &#123;</span><br><span class="line">			rec.t = temp;</span><br><span class="line">			rec.p = r.<span class="built_in">point_at_parameter</span>(rec.t);</span><br><span class="line">			rec.normal = (rec.p - center) / radius;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		temp = (-b + <span class="built_in">sqrt</span>(b * b - a * c)) / a;</span><br><span class="line">		<span class="keyword">if</span> (temp &lt; tmax &amp;&amp; temp &gt; tmin) &#123;</span><br><span class="line">			rec.t = temp;</span><br><span class="line">			rec.p = r.<span class="built_in">point_at_parameter</span>(rec.t);</span><br><span class="line">			rec.normal = (rec.p - center) / radius;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//RAYTRACINGTOY_SPHERE_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>还需要一个hitable list去记录击中所有的物体，也是继承hitable类，实现hit方法，去找出最近的物体。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by yw_li on 2022/9/13.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> RAYTRACINGTOY_HITABLELIST_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RAYTRACINGTOY_HITABLELIST_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hitable.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">hitable_list</span> : <span class="keyword">public</span> hitable &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">hitable_list</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">hitable_list</span>(hitable **l, <span class="type">int</span> n) &#123;</span><br><span class="line">		list = l;</span><br><span class="line">		list_size = n;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">hit</span><span class="params">(<span class="type">const</span> ray &amp;r, <span class="type">float</span> tmin, <span class="type">float</span> tmax, hit_record &amp;rec)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">	hitable **list; <span class="comment">// 元素类型为hitable的数组</span></span><br><span class="line">	<span class="type">int</span> list_size; <span class="comment">// hitable list元素个数</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">hitable_list::hit</span><span class="params">(<span class="type">const</span> ray &amp;r, <span class="type">float</span> tmin, <span class="type">float</span> tmax, hit_record &amp;rec)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">	hit_record temp_rec;</span><br><span class="line">	<span class="type">bool</span> hit_anything = <span class="literal">false</span>;</span><br><span class="line">	<span class="type">double</span> closet_so_far = tmax;</span><br><span class="line">	<span class="comment">// 对hitable list中的所有元素进行hit检测，并将最近的hit信息存入rec中</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; list_size; i++) &#123;</span><br><span class="line">		<span class="comment">// 每次只对[tmin, closet_so_far]范围内的检测hit，即</span></span><br><span class="line">		<span class="keyword">if</span> (list[i]-&gt;<span class="built_in">hit</span>(r, tmin, closet_so_far, temp_rec)) &#123;</span><br><span class="line">			hit_anything = <span class="literal">true</span>;</span><br><span class="line">			closet_so_far = temp_rec.t; <span class="comment">// 更新closet_so_far信息，closet_so_far只会越来越小</span></span><br><span class="line">			rec = temp_rec;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> hit_anything;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//RAYTRACINGTOY_HITABLELIST_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>更新过的main.cpp如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;float.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vec3.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ray.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sphere.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hitablelist.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// \param r 射线</span></span><br><span class="line"><span class="comment">/// \param world 可碰撞物体</span></span><br><span class="line"><span class="comment">/// \return 射线交点处的颜色，发生碰撞返回碰撞点法线，未发生碰撞返回背景色</span></span><br><span class="line"><span class="function">vec3 <span class="title">color</span><span class="params">(<span class="type">const</span> ray &amp;r, hitable *world)</span> </span>&#123;</span><br><span class="line">	hit_record rec;</span><br><span class="line">	<span class="keyword">if</span> (world-&gt;<span class="built_in">hit</span>(r, <span class="number">0.0</span>, FLT_MAX, rec)) &#123;</span><br><span class="line">		<span class="comment">// 如果射线与物体发生碰撞，则将碰撞点法线向量从[-1,1]映射到[0,1]</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0.5</span> * <span class="built_in">vec3</span>(rec.normal.<span class="built_in">x</span>() + <span class="number">1</span>, rec.normal.<span class="built_in">y</span>() + <span class="number">1</span>, rec.normal.<span class="built_in">z</span>() + <span class="number">1</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// 如果射线没有与物体发生碰撞，则返回背景的颜色</span></span><br><span class="line">		vec3 unit_direction = <span class="built_in">unit_vector</span>(r.<span class="built_in">direction</span>());</span><br><span class="line">		<span class="type">float</span> t = <span class="number">0.5</span> * (unit_direction.<span class="built_in">y</span>() + <span class="number">1.0</span>);</span><br><span class="line">		<span class="keyword">return</span> (<span class="number">1.0</span> - t) * <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>) + t * <span class="built_in">vec3</span>(<span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">1.0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="type">int</span> nx = <span class="number">200</span>;</span><br><span class="line">	<span class="type">int</span> ny = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 以写模式打开文件</span></span><br><span class="line">	std::ofstream outfile;</span><br><span class="line">	outfile.<span class="built_in">open</span>(<span class="string">&quot;color.ppm&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PPM格式，P3表示颜色以ASCII表示，200行，100列，最大颜色数量255</span></span><br><span class="line">	outfile &lt;&lt; <span class="string">&quot;P3\n&quot;</span> &lt;&lt; nx &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ny &lt;&lt; <span class="string">&quot;\n255\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">vec3 <span class="title">lower_left_corner</span><span class="params">(<span class="number">-2.0</span>, <span class="number">-1.0</span>, <span class="number">-1.0</span>)</span></span>; <span class="comment">// 定义左下角</span></span><br><span class="line">	<span class="function">vec3 <span class="title">horizontal</span><span class="params">(<span class="number">4.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>)</span></span>; <span class="comment">// x轴向右，最大为4</span></span><br><span class="line">	<span class="function">vec3 <span class="title">vertical</span><span class="params">(<span class="number">0.0</span>, <span class="number">2.0</span>, <span class="number">0.0</span>)</span></span>; <span class="comment">// y轴向上，最高为2</span></span><br><span class="line">	<span class="function">vec3 <span class="title">origin</span><span class="params">(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>)</span></span>; <span class="comment">// 摄像机在坐标原点</span></span><br><span class="line"></span><br><span class="line">	hitable *list[<span class="number">2</span>];</span><br><span class="line">	list[<span class="number">0</span>] = <span class="keyword">new</span> <span class="built_in">sphere</span>(<span class="built_in">vec3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">-1</span>), <span class="number">0.5</span>);</span><br><span class="line">	list[<span class="number">1</span>] = <span class="keyword">new</span> <span class="built_in">sphere</span>(<span class="built_in">vec3</span>(<span class="number">0</span>, <span class="number">-100.5</span>, <span class="number">-1</span>), <span class="number">100</span>);</span><br><span class="line">	hitable *world = <span class="keyword">new</span> <span class="built_in">hitable_list</span>(list, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> j = ny - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nx; i++) &#123;</span><br><span class="line">			<span class="type">float</span> u = <span class="built_in">float</span>(i) / <span class="built_in">float</span>(nx);</span><br><span class="line">			<span class="type">float</span> v = <span class="built_in">float</span>(j) / <span class="built_in">float</span>(ny);</span><br><span class="line"></span><br><span class="line">			<span class="function">ray <span class="title">r</span><span class="params">(origin, lower_left_corner + u * horizontal + v * vertical)</span></span>;</span><br><span class="line">			vec3 p = r.<span class="built_in">point_at_parameter</span>(<span class="number">2.0</span>);</span><br><span class="line">			vec3 col = <span class="built_in">color</span>(r, world);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 将（0，1）映射到（0，255.99）</span></span><br><span class="line">			<span class="type">int</span> ir = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">0</span>]);</span><br><span class="line">			<span class="type">int</span> ig = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">1</span>]);</span><br><span class="line">			<span class="type">int</span> ib = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">2</span>]);</span><br><span class="line">			outfile &lt;&lt; ir &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ig &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ib &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	outfile.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最终的结果：</p>
<p><img src="/.com//image-20220914013825807.png" alt="image-20220914013825807"></p>
<h2 id="chapter-6-antialiasing"><a class="markdownIt-Anchor" href="#chapter-6-antialiasing"></a> Chapter 6 : Antialiasing</h2>
<p>本节目标是实现抗锯齿，首先需要实现在一定范围内的随机采样，因此我们需要一个随机函数。我们用到random头文件，利用rand()函数。</p>
<ul>
<li>要取得 [a,b) 的随机整数，使用 (rand() % (b-a))+ a;</li>
<li>要取得 [a,b] 的随机整数，使用 (rand() % (b-a+1))+ a;</li>
<li>要取得 (a,b] 的随机整数，使用 (rand() % (b-a))+ a + 1;</li>
<li>通用公式: a + rand() % n；其中的 a 是起始值，n 是整数的范围。</li>
<li>要取得 a 到 b 之间的随机整数，另一种表示：a + (int)b * rand() / (RAND_MAX + 1)。</li>
<li>要取得 0～1 之间的浮点数，可以使用 rand() / double(RAND_MAX)。</li>
</ul>
<p>因此我们可以在main.cpp定义一个宏，用来生成<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>a</mi><mi mathvariant="normal">.</mi><mi>b</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[a.b]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal">a</span><span class="mord">.</span><span class="mord mathnormal">b</span><span class="mclose">]</span></span></span></span>之间的随机数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> random(a, b) (rand()%(b-a+1)+a)</span></span><br></pre></td></tr></table></figure>
<p>当然，缺点是每此生成的随机结果都是一样的。</p>
<p>对于给定的一个像素，我们有好几个随机的采样点，对每个采样点进行ray tracer，然后再平均结果。</p>
<p><img src="/.com//image-20220919165426334.png" alt="image-20220919165426334"></p>
<p>然后我们实现一个camera类。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by yw_li on 2022/9/15.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> RAYTRACINGTOY_CAMERA_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RAYTRACINGTOY_CAMERA_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ray.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">camera</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">camera</span>() &#123;</span><br><span class="line">		lower_left_corner = <span class="built_in">vec3</span>(<span class="number">-2.0</span>, <span class="number">-1.0</span>, <span class="number">-1.0</span>);</span><br><span class="line">		horizontal = <span class="built_in">vec3</span>(<span class="number">4.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">		vertical = <span class="built_in">vec3</span>(<span class="number">0.0</span>, <span class="number">2.0</span>, <span class="number">0.0</span>);</span><br><span class="line">		origin = <span class="built_in">vec3</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">ray <span class="title">get_ray</span><span class="params">(<span class="type">float</span> u, <span class="type">float</span> v)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">ray</span>(origin, lower_left_corner + u * horizontal + v * vertical - origin);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	vec3 origin;</span><br><span class="line">	vec3 lower_left_corner;</span><br><span class="line">	vec3 horizontal;</span><br><span class="line">	vec3 vertical;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//RAYTRACINGTOY_CAMERA_H</span></span></span><br></pre></td></tr></table></figure>
<p>最终的main.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;float.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vec3.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ray.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sphere.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hitablelist.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;camera.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;random&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> random(a, b) (rand()%(b-a+1)+a)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// \param r 射线</span></span><br><span class="line"><span class="comment">/// \param world 可碰撞物体</span></span><br><span class="line"><span class="comment">/// \return 射线交点处的颜色，发生碰撞返回碰撞点法线，未发生碰撞返回背景色</span></span><br><span class="line"><span class="function">vec3 <span class="title">color</span><span class="params">(<span class="type">const</span> ray &amp;r, hitable *world)</span> </span>&#123;</span><br><span class="line">	hit_record rec;</span><br><span class="line">	<span class="keyword">if</span> (world-&gt;<span class="built_in">hit</span>(r, <span class="number">0.0</span>, FLT_MAX, rec)) &#123;</span><br><span class="line">		<span class="comment">// 如果射线与物体发生碰撞，则将碰撞点法线向量从[-1,1]映射到[0,1]</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0.5</span> * <span class="built_in">vec3</span>(rec.normal.<span class="built_in">x</span>() + <span class="number">1</span>, rec.normal.<span class="built_in">y</span>() + <span class="number">1</span>, rec.normal.<span class="built_in">z</span>() + <span class="number">1</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// 如果射线没有与物体发生碰撞，则返回背景的颜色</span></span><br><span class="line">		vec3 unit_direction = <span class="built_in">unit_vector</span>(r.<span class="built_in">direction</span>());</span><br><span class="line">		<span class="type">float</span> t = <span class="number">0.5</span> * (unit_direction.<span class="built_in">y</span>() + <span class="number">1.0</span>);</span><br><span class="line">		<span class="keyword">return</span> (<span class="number">1.0</span> - t) * <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>) + t * <span class="built_in">vec3</span>(<span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">1.0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="type">int</span> nx = <span class="number">200</span>;</span><br><span class="line">	<span class="type">int</span> ny = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> ns = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 以写模式打开文件</span></span><br><span class="line">	std::ofstream outfile;</span><br><span class="line">	outfile.<span class="built_in">open</span>(<span class="string">&quot;color.ppm&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PPM格式，P3表示颜色以ASCII表示，200行，100列，最大颜色数量255</span></span><br><span class="line">	outfile &lt;&lt; <span class="string">&quot;P3\n&quot;</span> &lt;&lt; nx &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ny &lt;&lt; <span class="string">&quot;\n255\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">	camera cam;</span><br><span class="line"></span><br><span class="line">	hitable *list[<span class="number">2</span>];</span><br><span class="line">	list[<span class="number">0</span>] = <span class="keyword">new</span> <span class="built_in">sphere</span>(<span class="built_in">vec3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">-1</span>), <span class="number">0.5</span>);</span><br><span class="line">	list[<span class="number">1</span>] = <span class="keyword">new</span> <span class="built_in">sphere</span>(<span class="built_in">vec3</span>(<span class="number">0</span>, <span class="number">-100.5</span>, <span class="number">-1</span>), <span class="number">100</span>);</span><br><span class="line">	hitable *world = <span class="keyword">new</span> <span class="built_in">hitable_list</span>(list, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> j = ny - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nx; i++) &#123;</span><br><span class="line">			<span class="function">vec3 <span class="title">col</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 随机生成ns个采样点，并将颜色叠加</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> s = <span class="number">0</span>; s &lt; ns; s++) &#123;</span><br><span class="line">				<span class="type">float</span> u = <span class="built_in">float</span>((i + <span class="built_in">random</span>(<span class="number">0</span>, <span class="number">100</span>) / <span class="number">100</span>) / <span class="built_in">float</span>(nx));</span><br><span class="line">				<span class="type">float</span> v = <span class="built_in">float</span>((j + <span class="built_in">random</span>(<span class="number">0</span>, <span class="number">100</span>) / <span class="number">100</span>) / <span class="built_in">float</span>(ny));</span><br><span class="line"></span><br><span class="line">				ray r = cam.<span class="built_in">get_ray</span>(u, v);</span><br><span class="line">				vec3 p = r.<span class="built_in">point_at_parameter</span>(<span class="number">2.0</span>);</span><br><span class="line">				col += <span class="built_in">color</span>(r, world);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			col /= <span class="built_in">float</span>(ns);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 将（0，1）映射到（0，255.99）</span></span><br><span class="line">			<span class="type">int</span> ir = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">0</span>]);</span><br><span class="line">			<span class="type">int</span> ig = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">1</span>]);</span><br><span class="line">			<span class="type">int</span> ib = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">2</span>]);</span><br><span class="line">			outfile &lt;&lt; ir &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ig &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ib &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	outfile.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="chapter7-diffuse-materials"><a class="markdownIt-Anchor" href="#chapter7-diffuse-materials"></a> Chapter7 : Diffuse Materials</h2>
<p>本章的目标是实现漫反射。</p>
<p>通常在渲染中，每个物体都有自己的材质。</p>
<p>对于不发光的物体，漫反射是吸收周围的颜色，并与自身的颜色混合调节。</p>
<p>从漫反射物体表面反射的光线的方向是随机的。因此，如下图，如果我们向两个漫反射物体形成的夹缝中射入3条光线，会有不同的反射路径结果。</p>
<p><img src="/.com//image-20220919170654874.png" alt="image-20220919170654874"></p>
<p>物体表面越暗，看起来越像是光线被吸收了，吸收之后的表面更像是是一个哑光的表面。</p>
<p>我们选择表面上一点hitpoint点<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>，在该点做一个与表面相切的单位球，这个球的球心是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>P</mi><mo>+</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(P+N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>，我们从球体中随机选择一个点<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>，从hitpoint点<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>处，发射一条由<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>指向<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>的射线作为漫反射的方向。</p>
<p><img src="/.com//image-20220919171416861.png" alt="image-20220919171416861"></p>
<p>我们构造一个方法来从单位半径球体中选择一个随机点：首先，选择一个单位立方体中的随机点，其中x，y，z的范围都在-1到+1之间。如果这个点在球体外，则重新选择一个随机点。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 单位cube随机取点，并返回处于球体内的一点</span></span><br><span class="line"><span class="comment">/// \return</span></span><br><span class="line"><span class="function">vec3 <span class="title">random_in_unit_sphere</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	vec3 p;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="comment">//srand((unsigned) time(NULL));</span></span><br><span class="line">		p = <span class="number">2.0</span> * <span class="built_in">vec3</span>(random1, random1, random1) - <span class="built_in">vec3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">		<span class="comment">//std::cout &lt;&lt; random(0, 100) / 100 &lt;&lt; std::endl;</span></span><br><span class="line">	&#125; <span class="keyword">while</span> (<span class="built_in">dot</span>(p, p) &gt;= <span class="number">1.0</span>); <span class="comment">// 如果点在半径为1的球体外，则重新生成</span></span><br><span class="line">	<span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// \param r 射线</span></span><br><span class="line"><span class="comment">/// \param world 可碰撞物体</span></span><br><span class="line"><span class="comment">/// \return 射线交点处的颜色，发生碰撞返回碰撞点法线，未发生碰撞返回背景色</span></span><br><span class="line"><span class="function">vec3 <span class="title">color</span><span class="params">(<span class="type">const</span> ray &amp;r, hitable *world)</span> </span>&#123;</span><br><span class="line">	hit_record rec;</span><br><span class="line">	<span class="keyword">if</span> (world-&gt;<span class="built_in">hit</span>(r, <span class="number">0.0</span>, FLT_MAX, rec)) &#123;</span><br><span class="line">		vec3 target = rec.p + rec.normal + <span class="built_in">random_in_unit_sphere</span>();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0.5</span> * <span class="built_in">color</span>(<span class="built_in">ray</span>(rec.p, target - rec.p), world);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// 如果射线没有与物体发生碰撞，则返回背景的颜色</span></span><br><span class="line">		vec3 unit_direction = <span class="built_in">unit_vector</span>(r.<span class="built_in">direction</span>());</span><br><span class="line">		<span class="type">float</span> t = <span class="number">0.5</span> * (unit_direction.<span class="built_in">y</span>() + <span class="number">1.0</span>);</span><br><span class="line">		<span class="keyword">return</span> (<span class="number">1.0</span> - t) * <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>) + t * <span class="built_in">vec3</span>(<span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">1.0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时我们得到的结果：</p>
<p><img src="/.com//image-20220920001101349.png" alt="image-20220920001101349"></p>
<p>可以看出球体底部过暗，因此我们可以进行gamma补偿。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">col /= <span class="built_in">float</span>(ns);</span><br><span class="line"><span class="comment">// 进行gamma补偿</span></span><br><span class="line">col = <span class="built_in">vec3</span>(<span class="built_in">sqrt</span>(col[<span class="number">0</span>]), <span class="built_in">sqrt</span>(col[<span class="number">1</span>]), <span class="built_in">sqrt</span>(col[<span class="number">2</span>]));</span><br><span class="line"><span class="comment">// 将（0，1）映射到（0，255.99）</span></span><br><span class="line"><span class="type">int</span> ir = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">0</span>]);</span><br><span class="line"><span class="type">int</span> ig = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">1</span>]);</span><br><span class="line"><span class="type">int</span> ib = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">2</span>]);</span><br></pre></td></tr></table></figure>
<p>得到的补偿后的结果：</p>
<p><img src="/.com//image-20220920001519893.png" alt="image-20220920001519893"></p>
<p>最终的mian.cpp：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;float.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vec3.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ray.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sphere.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hitablelist.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;camera.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;random&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> random(a, b) (rand()%(b-a+1)+a) <span class="comment">//使用rand()的一个后果是，种子相同时每次的随机结果都相同</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> random1 (float((rand() % 100) / 100.f))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 单位cube随机取点，并返回处于球体内的一点</span></span><br><span class="line"><span class="comment">/// \return</span></span><br><span class="line"><span class="function">vec3 <span class="title">random_in_unit_sphere</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	vec3 p;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="comment">//srand((unsigned) time(NULL));</span></span><br><span class="line">		p = <span class="number">2.0</span> * <span class="built_in">vec3</span>(random1, random1, random1) - <span class="built_in">vec3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">		<span class="comment">//std::cout &lt;&lt; random(0, 100) / 100 &lt;&lt; std::endl;</span></span><br><span class="line">	&#125; <span class="keyword">while</span> (<span class="built_in">dot</span>(p, p) &gt;= <span class="number">1.0</span>); <span class="comment">// 如果点在半径为1的球体外，则重新生成</span></span><br><span class="line">	<span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// \param r 射线</span></span><br><span class="line"><span class="comment">/// \param world 可碰撞物体</span></span><br><span class="line"><span class="comment">/// \return 射线交点处的颜色，发生碰撞返回碰撞点法线，未发生碰撞返回背景色</span></span><br><span class="line"><span class="function">vec3 <span class="title">color</span><span class="params">(<span class="type">const</span> ray &amp;r, hitable *world)</span> </span>&#123;</span><br><span class="line">	hit_record rec;</span><br><span class="line">	<span class="keyword">if</span> (world-&gt;<span class="built_in">hit</span>(r, <span class="number">0.0</span>, FLT_MAX, rec)) &#123;</span><br><span class="line">		vec3 target = rec.p + rec.normal + <span class="built_in">random_in_unit_sphere</span>();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0.5</span> * <span class="built_in">color</span>(<span class="built_in">ray</span>(rec.p, target - rec.p), world);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// 如果射线没有与物体发生碰撞，则返回背景的颜色</span></span><br><span class="line">		vec3 unit_direction = <span class="built_in">unit_vector</span>(r.<span class="built_in">direction</span>());</span><br><span class="line">		<span class="type">float</span> t = <span class="number">0.5</span> * (unit_direction.<span class="built_in">y</span>() + <span class="number">1.0</span>);</span><br><span class="line">		<span class="keyword">return</span> (<span class="number">1.0</span> - t) * <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>) + t * <span class="built_in">vec3</span>(<span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">1.0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="type">int</span> nx = <span class="number">200</span>;</span><br><span class="line">	<span class="type">int</span> ny = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> ns = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 以写模式打开文件</span></span><br><span class="line">	std::ofstream outfile;</span><br><span class="line">	outfile.<span class="built_in">open</span>(<span class="string">&quot;color.ppm&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PPM格式，P3表示颜色以ASCII表示，200行，100列，最大颜色数量255</span></span><br><span class="line">	outfile &lt;&lt; <span class="string">&quot;P3\n&quot;</span> &lt;&lt; nx &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ny &lt;&lt; <span class="string">&quot;\n255\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">	camera cam;</span><br><span class="line"></span><br><span class="line">	hitable *list[<span class="number">2</span>];</span><br><span class="line">	list[<span class="number">0</span>] = <span class="keyword">new</span> <span class="built_in">sphere</span>(<span class="built_in">vec3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">-1</span>), <span class="number">0.5</span>); <span class="comment">// 球1</span></span><br><span class="line">	list[<span class="number">1</span>] = <span class="keyword">new</span> <span class="built_in">sphere</span>(<span class="built_in">vec3</span>(<span class="number">0</span>, <span class="number">-100.5</span>, <span class="number">-1</span>), <span class="number">100</span>); <span class="comment">// 球2</span></span><br><span class="line">	hitable *world = <span class="keyword">new</span> <span class="built_in">hitable_list</span>(list, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> j = ny - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nx; i++) &#123;</span><br><span class="line">			<span class="function">vec3 <span class="title">col</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 随机生成ns个采样点，并将颜色叠加</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> s = <span class="number">0</span>; s &lt; ns; s++) &#123;</span><br><span class="line">				<span class="comment">//srand((unsigned) time(NULL));</span></span><br><span class="line">				<span class="type">float</span> u = <span class="built_in">float</span>((i + <span class="built_in">random</span>(<span class="number">0</span>, <span class="number">100</span>) / <span class="number">100</span>) / <span class="built_in">float</span>(nx));</span><br><span class="line">				<span class="type">float</span> v = <span class="built_in">float</span>((j + <span class="built_in">random</span>(<span class="number">0</span>, <span class="number">100</span>) / <span class="number">100</span>) / <span class="built_in">float</span>(ny));</span><br><span class="line"></span><br><span class="line">				ray r = cam.<span class="built_in">get_ray</span>(u, v);</span><br><span class="line">				vec3 p = r.<span class="built_in">point_at_parameter</span>(<span class="number">2.0</span>);</span><br><span class="line">				col += <span class="built_in">color</span>(r, world);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			col /= <span class="built_in">float</span>(ns);</span><br><span class="line">			<span class="comment">// 进行gamma补偿</span></span><br><span class="line">			col = <span class="built_in">vec3</span>(<span class="built_in">sqrt</span>(col[<span class="number">0</span>]), <span class="built_in">sqrt</span>(col[<span class="number">1</span>]), <span class="built_in">sqrt</span>(col[<span class="number">2</span>]));</span><br><span class="line">			<span class="comment">// 将（0，1）映射到（0，255.99）</span></span><br><span class="line">			<span class="type">int</span> ir = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">0</span>]);</span><br><span class="line">			<span class="type">int</span> ig = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">1</span>]);</span><br><span class="line">			<span class="type">int</span> ib = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">2</span>]);</span><br><span class="line">			outfile &lt;&lt; ir &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ig &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ib &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	outfile.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="chapter-8-metal"><a class="markdownIt-Anchor" href="#chapter-8-metal"></a> Chapter 8 : Metal</h2>
<p>如果我们需要不同的物体拥有不同的材质，一种本方法是：我们可以定义一个具有很多参数的材质，每种不同的材质就是不同参数的组合。</p>
<p>或者我们可以定义一个材质的抽象类：</p>
<p>我们定义的材质需要能够做到：</p>
<ol>
<li>产生散射线（或者说它吸收了入射线）</li>
<li>如果发生散射，则应该确定光线究竟衰减了多少</li>
</ol>
<p>定义一个如下的material抽象类：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by yw_li on 2022/9/20.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> RAYTRACINGTOY_MATERIAL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RAYTRACINGTOY_MATERIAL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ray.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hitable.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">material</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">scatter</span><span class="params">(<span class="type">const</span> ray &amp;r_in, <span class="type">const</span> hit_record &amp;rec, vec3 &amp;attenuation, ray &amp;scattered)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//RAYTRACINGTOY_MATERIAL_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在我们计算碰撞的信息时，我们需要获得碰撞处的材质，因此我们在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mi>i</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>r</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>r</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">hit\_record</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathnormal">h</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">d</span></span></span></span>类中添加一个指向材质的指针：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by yw_li on 2022/9/13.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> RAYTRACINGTOY_HITABLE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RAYTRACINGTOY_HITABLE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ray.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;material.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">hit_record</span> &#123;</span><br><span class="line">	<span class="type">float</span> t; <span class="comment">// 射线参数t</span></span><br><span class="line">	vec3 p; <span class="comment">// 射线与物体的交点（碰撞点）</span></span><br><span class="line">	vec3 normal; <span class="comment">// 碰撞点处的法线向量</span></span><br><span class="line">	material *mat_ptr; <span class="comment">// 保存碰撞点处的材质</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">hitable</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">hit</span><span class="params">(<span class="type">const</span> ray &amp;r, <span class="type">float</span> t_min, <span class="type">float</span> t_max, hit_record &amp;rec)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//RAYTRACINGTOY_HITABLE_H</span></span></span><br></pre></td></tr></table></figure>
<p>对于我们已经拥有的Lambertian（漫反射）情况，它既可以总是散射，也可以通过其反射率<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span>衰减，或者它可以在没有衰减的情况下散射但吸收部分<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><mi>R</mi></mrow><annotation encoding="application/x-tex">1-R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span>射线，或者混合使用这些策略。对于Lambertian材质，我们可以设计这样一个类：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">lambertian</span> : <span class="keyword">public</span> material &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">lambertian</span>(<span class="type">const</span> vec3 &amp;a) : <span class="built_in">albedo</span>(a) &#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">scatter</span><span class="params">(<span class="type">const</span> ray &amp;r_in, <span class="type">const</span> hit_record &amp;rec, vec3 &amp;attenuation, ray &amp;scattered)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">		vec3 target = rec.p + rec.normal + <span class="built_in">random_in_unit_sphere</span>(); <span class="comment">// 散射方向由random_in_unit_sphere()控制</span></span><br><span class="line">		scattered = <span class="built_in">ray</span>(rec.p, target - rec.p);</span><br><span class="line">		attenuation = albedo; <span class="comment">// attenuation衰减，控制散射后的光纤强度</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	vec3 albedo; <span class="comment">// 反射率</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们也可以仅按照某个概率<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span></span></span></span>进行散射，并且衰减为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>l</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi>o</mi><mi mathvariant="normal">/</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">albedo/p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">b</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord">/</span><span class="mord mathnormal">p</span></span></span></span>。</p>
<p>对于<strong>光滑</strong>的表面，光线不会随机散射。光滑表面的光线反射物理规律是<strong>出射角等于入射角，会发生镜面反射</strong>。</p>
<p><img src="/.com//image-20220920170048181.png" alt="image-20220920170048181"></p>
<p>图中红色的是反射光线，向量表示为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>v</mi><mo>+</mo><mn>2</mn><mi>B</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(v+2B)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>是单位法向量，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span>是入射光线的方向向量，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>的模是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>的点乘<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>o</mi><mi>t</mi><mo stretchy="false">(</mo><mi>v</mi><mo separator="true">,</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">dot(v,N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>。公式为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 求镜面反射出射向量</span></span><br><span class="line"><span class="comment">/// \param v 入射光线向量</span></span><br><span class="line"><span class="comment">/// \param n 平面单位法向量</span></span><br><span class="line"><span class="comment">/// \return 出射光线向量</span></span><br><span class="line"><span class="function">vec3 <span class="title">reflect</span><span class="params">(<span class="type">const</span> vec3 &amp;v, <span class="type">const</span> vec3 &amp;n)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> v - <span class="number">2</span> * <span class="built_in">dot</span>(v, n) * n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来我们就可以利用镜面反射来构造一个金属材质（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">matel</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span>）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 金属材质</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">metal</span> : <span class="keyword">public</span> material &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">metal</span>(<span class="type">const</span> vec3 &amp;a) : <span class="built_in">albedo</span>(a) &#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">scatter</span><span class="params">(<span class="type">const</span> ray &amp;r_in, <span class="type">const</span> hit_record &amp;rec, vec3 &amp;attenuation, ray &amp;scattered)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">		vec3 reflected = <span class="built_in">reflect</span>(<span class="built_in">unit_vector</span>(r_in.<span class="built_in">direction</span>()), rec.normal);</span><br><span class="line">		scattered = <span class="built_in">ray</span>(rec.p, reflected);</span><br><span class="line">		attenuation = albedo;</span><br><span class="line">		<span class="keyword">return</span> (<span class="built_in">dot</span>(scattered.<span class="built_in">direction</span>(), rec.normal) &gt; <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	vec3 albedo; <span class="comment">// 反射率</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后我们对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>l</mi><mi>o</mi><mi>r</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">color()</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mclose">)</span></span></span></span>函数进行修改：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// \param r 射线</span></span><br><span class="line"><span class="comment">/// \param world 可碰撞物体</span></span><br><span class="line"><span class="comment">/// \param depth 反射深度</span></span><br><span class="line"><span class="comment">/// \return 射线交点处的颜色，发生碰撞返回碰撞点法线，未发生碰撞返回背景色</span></span><br><span class="line"><span class="function">vec3 <span class="title">color</span><span class="params">(<span class="type">const</span> ray &amp;r, hitable *world, <span class="type">int</span> depth)</span> </span>&#123;</span><br><span class="line">	hit_record rec;</span><br><span class="line">	<span class="keyword">if</span> (world-&gt;<span class="built_in">hit</span>(r, <span class="number">0.0001</span>, FLT_MAX, rec)) &#123;</span><br><span class="line">		ray scattered;</span><br><span class="line">		vec3 attenuation;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (depth &lt; <span class="number">50</span> &amp;&amp; rec.mat_ptr-&gt;<span class="built_in">scatter</span>(r, rec, attenuation, scattered)) &#123;</span><br><span class="line">			<span class="keyword">return</span> attenuation * <span class="built_in">color</span>(scattered, world, depth + <span class="number">1</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">vec3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// 如果射线没有与物体发生碰撞，则返回背景的颜色</span></span><br><span class="line">		vec3 unit_direction = <span class="built_in">unit_vector</span>(r.<span class="built_in">direction</span>());</span><br><span class="line">		<span class="type">float</span> t = <span class="number">0.5</span> * (unit_direction.<span class="built_in">y</span>() + <span class="number">1.0</span>);</span><br><span class="line">		<span class="keyword">return</span> (<span class="number">1.0</span> - t) * <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>) + t * <span class="built_in">vec3</span>(<span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">1.0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也需要对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>p</mi><mi>h</mi><mi>e</mi><mi>r</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">sphere</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span></span></span></span>类进行修改：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">sphere</span> : <span class="keyword">public</span> hitable &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">sphere</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 构造球心为cen，半径为r的球体</span></span><br><span class="line">	<span class="built_in">sphere</span>(vec3 cen, <span class="type">float</span> r, material *mat) : <span class="built_in">center</span>(cen), <span class="built_in">radius</span>(r), <span class="built_in">mat_ptr</span>(mat) &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">hit</span><span class="params">(<span class="type">const</span> ray &amp;r, <span class="type">float</span> tmin, <span class="type">float</span> tmax, hit_record &amp;rec)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">	vec3 center; <span class="comment">// 球心坐标</span></span><br><span class="line">	<span class="type">float</span> radius; <span class="comment">// 球体半径</span></span><br><span class="line">	material *mat_ptr; <span class="comment">// 球体材质</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>a</mi><mi>i</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">main</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">a</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span></span></span></span>中新建两个金属球：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="type">int</span> nx = <span class="number">600</span>;</span><br><span class="line">	<span class="type">int</span> ny = <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> ns = <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 以写模式打开文件</span></span><br><span class="line">	std::ofstream outfile;</span><br><span class="line">	outfile.<span class="built_in">open</span>(<span class="string">&quot;color.ppm&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PPM格式，P3表示颜色以ASCII表示，200行，100列，最大颜色数量255</span></span><br><span class="line">	outfile &lt;&lt; <span class="string">&quot;P3\n&quot;</span> &lt;&lt; nx &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ny &lt;&lt; <span class="string">&quot;\n255\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">	camera cam;</span><br><span class="line"></span><br><span class="line">	hitable *list[<span class="number">2</span>];</span><br><span class="line">	list[<span class="number">0</span>] = <span class="keyword">new</span> <span class="built_in">sphere</span>(<span class="built_in">vec3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">-1</span>), <span class="number">0.5</span>, <span class="keyword">new</span> <span class="built_in">lambertian</span>(<span class="built_in">vec3</span>(<span class="number">0.8</span>, <span class="number">0.3</span>, <span class="number">0.3</span>))); <span class="comment">// 球1</span></span><br><span class="line">	list[<span class="number">1</span>] = <span class="keyword">new</span> <span class="built_in">sphere</span>(<span class="built_in">vec3</span>(<span class="number">0</span>, <span class="number">-100.5</span>, <span class="number">-1</span>), <span class="number">100</span>, <span class="keyword">new</span> <span class="built_in">lambertian</span>(<span class="built_in">vec3</span>(<span class="number">0.8</span>, <span class="number">0.8</span>, <span class="number">0.8</span>))); <span class="comment">// 球2</span></span><br><span class="line">	list[<span class="number">2</span>] = <span class="keyword">new</span> <span class="built_in">sphere</span>(<span class="built_in">vec3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">-1</span>), <span class="number">0.5</span>, <span class="keyword">new</span> <span class="built_in">metal</span>(<span class="built_in">vec3</span>(<span class="number">0.8</span>, <span class="number">0.6</span>, <span class="number">0.2</span>))); <span class="comment">// 球3金属球</span></span><br><span class="line">	list[<span class="number">3</span>] = <span class="keyword">new</span> <span class="built_in">sphere</span>(<span class="built_in">vec3</span>(<span class="number">-1</span>, <span class="number">0</span>, <span class="number">-1</span>), <span class="number">0.5</span>, <span class="keyword">new</span> <span class="built_in">metal</span>(<span class="built_in">vec3</span>(<span class="number">0.8</span>, <span class="number">0.8</span>, <span class="number">0.8</span>))); <span class="comment">// 球4金属球</span></span><br><span class="line">	hitable *world = <span class="keyword">new</span> <span class="built_in">hitable_list</span>(list, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> j = ny - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nx; i++) &#123;</span><br><span class="line">			<span class="function">vec3 <span class="title">col</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 随机生成ns个采样点，并将颜色叠加</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> s = <span class="number">0</span>; s &lt; ns; s++) &#123;</span><br><span class="line">				<span class="comment">//srand((unsigned) time(NULL));</span></span><br><span class="line">				<span class="type">float</span> u = <span class="built_in">float</span>((i + <span class="built_in">random</span>(<span class="number">0</span>, <span class="number">100</span>) / <span class="number">100</span>) / <span class="built_in">float</span>(nx));</span><br><span class="line">				<span class="type">float</span> v = <span class="built_in">float</span>((j + <span class="built_in">random</span>(<span class="number">0</span>, <span class="number">100</span>) / <span class="number">100</span>) / <span class="built_in">float</span>(ny));</span><br><span class="line"></span><br><span class="line">				ray r = cam.<span class="built_in">get_ray</span>(u, v);</span><br><span class="line">				vec3 p = r.<span class="built_in">point_at_parameter</span>(<span class="number">2.0</span>);</span><br><span class="line">				col += <span class="built_in">color</span>(r, world, <span class="number">0</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			col /= <span class="built_in">float</span>(ns);</span><br><span class="line">			<span class="comment">// 进行gamma补偿</span></span><br><span class="line">			col = <span class="built_in">vec3</span>(<span class="built_in">sqrt</span>(col[<span class="number">0</span>]), <span class="built_in">sqrt</span>(col[<span class="number">1</span>]), <span class="built_in">sqrt</span>(col[<span class="number">2</span>]));</span><br><span class="line">			<span class="comment">// 将（0，1）映射到（0，255.99）</span></span><br><span class="line">			<span class="type">int</span> ir = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">0</span>]);</span><br><span class="line">			<span class="type">int</span> ig = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">1</span>]);</span><br><span class="line">			<span class="type">int</span> ib = <span class="built_in">int</span>(<span class="number">255.99</span> * col[<span class="number">2</span>]);</span><br><span class="line">			outfile &lt;&lt; ir &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ig &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; ib &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	outfile.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时的结果：</p>
<p><img src="/.com//image-20220920174800044.png" alt="image-20220920174800044"></p>
<p>对于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>e</mi><mi>t</mi><mi>a</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">metal</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span>的材质，也可以用一个随机性的反射方向，来做微量的偏移，相当于在一个小球上选择一个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>n</mi><mi>d</mi><mi>p</mi><mi>o</mi><mi>i</mi><mi>n</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">endpoint</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mord mathnormal">o</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span></span></span></span>，而<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>u</mi><mi>z</mi><mi>z</mi><mi>i</mi><mi>n</mi><mi>s</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">fuzzinss</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span></span></span></span>就相当于这个小球的半径，可以决定反射偏移的多少，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>u</mi><mi>z</mi><mi>z</mi><mi>i</mi><mi>n</mi><mi>s</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">fuzzinss</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span></span></span></span>的取值在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0,1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>之间。</p>
<p><img src="/.com//image-20220920175010641.png" alt="image-20220920175010641"></p>
<h2 id="chapter9dielectrics"><a class="markdownIt-Anchor" href="#chapter9dielectrics"></a> Chapter9:Dielectrics</h2>
<p>透明的材料，如水，玻璃和钻石是电介质。</p>
<p>当一束光线照射到它们时，它会分裂成一束反射光线和一束折射(透射)光线。我们将通过在反射和折射之间随机选择并且每次相互作用只产生一个散射光来处理这个问题。</p>
<p>最难调试的部分是折射光。通常我们假设所有的折射，只有一条折射光线。我们先尝试在场景中放入两个玻璃球。得到如下图：</p>
<p><img src="/.com//image-20221012035029579.png" alt="image-20221012035029579"></p>
<p>但是看起来并不对，现实生活中没有黑色的东西。</p>
<p>光从一种介质进入另一种介质时，实际上，有一部分光会折射进入另一种介质，有另一部分光则会反射回来。反射系数=反射光振幅（能量）/入射光振幅（能量）。</p>
<p>折射满足斯涅尔定律（Snell’s law）：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>n</mi><mo>∗</mo><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mi>t</mi><mi>h</mi><mi>e</mi><mi>t</mi><mi>a</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>n</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>∗</mo><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mi>t</mi><mi>h</mi><mi>e</mi><mi>t</mi><msup><mi>a</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">n * sin(theta) = n&#x27; * sin(theta&#x27;)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.46528em;vertical-align:0em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.801892em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.051892em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>其中<code>n</code>和<code>n'</code>是折射率。一般空气的折射率为1，玻璃的折射率为1.3-1.7，钻石的折射率为2.4。</p>
<p><img src="/.com//image-20221012035740658.png" alt="image-20221012035740658"></p>
<p>一个棘手的实际问题是，当光现在具有较高折射率的材料中时，斯涅尔定律并没有真正的解决方案，不可能存在折射。所有的光线都在其内部反射，因为实际上这些光线通常在固体物体内部，所以被称为<strong>全内反射</strong>。这就是为什么有时当你被淹没在水中时，水-空气的界限就像一面完美的镜子。因此，折射的代码要比反射的代码复杂一些。</p>
<p>折射的部分代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">refract</span><span class="params">(<span class="type">const</span> vec3 &amp;v, <span class="type">const</span> vec3 &amp;n, <span class="type">float</span> ni_over_nt, vec3 &amp;refracted)</span> </span>&#123;</span><br><span class="line">	vec3 uv = <span class="built_in">unit_vector</span>(v);</span><br><span class="line">	<span class="type">float</span> dt = <span class="built_in">dot</span>(uv, n);</span><br><span class="line">	<span class="type">float</span> discriminant = <span class="number">1.0</span> - ni_over_nt * ni_over_nt * (<span class="number">1</span> - dt * dt);</span><br><span class="line">	<span class="keyword">if</span> (discriminant &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		refracted = ni_over_nt * (v - n * dt) - n * <span class="built_in">sqrt</span>(discriminant);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>电介质材质总是会发生折射，因此我们在材质类中派生dielectrics材质：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 电介质</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">dielectric</span> : <span class="keyword">public</span> material &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">dielectric</span>(<span class="type">float</span> ri) : <span class="built_in">ref_idx</span>(ri) &#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">scatter</span><span class="params">(<span class="type">const</span> ray &amp;r_in, <span class="type">const</span> hit_record &amp;rec, vec3 &amp;attenuation, ray &amp;scattered)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">		vec3 outward_normal;</span><br><span class="line">		vec3 reflected = <span class="built_in">reflect</span>(r_in.<span class="built_in">direction</span>(), rec.normal);</span><br><span class="line">		<span class="type">float</span> ni_over_nt;</span><br><span class="line">		attenuation = <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>);</span><br><span class="line">		vec3 refracted;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">dot</span>(r_in.<span class="built_in">direction</span>(), rec.normal) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			outward_normal = -rec.normal;</span><br><span class="line">			ni_over_nt = ref_idx;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			outward_normal = rec.normal;</span><br><span class="line">			ni_over_nt = <span class="number">1.0</span> / ref_idx;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">refract</span>(r_in.<span class="built_in">direction</span>(), outward_normal, ni_over_nt, refracted)) &#123;</span><br><span class="line">			scattered = <span class="built_in">ray</span>(rec.p, refracted);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			scattered = <span class="built_in">ray</span>(rec.p, reflected);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> ref_idx;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Attenuation（衰减）总为1，玻璃材质的表面不吸收任何光线。</p>
<p>我们将球4材质改为玻璃球。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list[<span class="number">3</span>] = <span class="keyword">new</span> <span class="built_in">sphere</span>(<span class="built_in">vec3</span>(<span class="number">-1</span>, <span class="number">0</span>, <span class="number">-1</span>), <span class="number">0.5</span>, <span class="keyword">new</span> <span class="built_in">dielectric</span>(<span class="number">1.5</span>)); <span class="comment">// 球4玻璃球</span></span><br></pre></td></tr></table></figure>
<p>真正的玻璃<strong>具有随角度变化的反射率</strong>，从陡峭的角度看窗户，它就变成了一面镜子。这里一个简陋但是大家都在用的，由Christophe Schlick提出的多项式近似：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">float</span> <span class="title">schlick</span><span class="params">(<span class="type">float</span> cosine, <span class="type">float</span> ref_idx)</span> </span>&#123;</span><br><span class="line">	<span class="type">float</span> r0 = (<span class="number">1</span> - ref_idx) / (<span class="number">1</span> + ref_idx);</span><br><span class="line">	r0 = r0 * r0;</span><br><span class="line">	<span class="keyword">return</span> r0 + (<span class="number">1</span> - r0) * <span class="built_in">pow</span>((<span class="number">1</span> - cosine), <span class="number">5</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此完成后的电介质材质：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 电介质</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">dielectric</span> : <span class="keyword">public</span> material &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">dielectric</span>(<span class="type">float</span> ri) : <span class="built_in">ref_idx</span>(ri) &#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">scatter</span><span class="params">(<span class="type">const</span> ray &amp;r_in, <span class="type">const</span> hit_record &amp;rec, vec3 &amp;attenuation, ray &amp;scattered)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">		vec3 outward_normal;</span><br><span class="line">		vec3 reflected = <span class="built_in">reflect</span>(r_in.<span class="built_in">direction</span>(), rec.normal);</span><br><span class="line">		<span class="type">float</span> ni_over_nt;</span><br><span class="line">		attenuation = <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>);</span><br><span class="line">		vec3 refracted;</span><br><span class="line">		<span class="type">float</span> reflect_prob;</span><br><span class="line">		<span class="type">float</span> cosine;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">dot</span>(r_in.<span class="built_in">direction</span>(), rec.normal) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			outward_normal = -rec.normal;</span><br><span class="line">			ni_over_nt = ref_idx;</span><br><span class="line">			cosine = ref_idx * <span class="built_in">dot</span>(r_in.<span class="built_in">direction</span>(), rec.normal) / r_in.<span class="built_in">direction</span>().<span class="built_in">length</span>();</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			outward_normal = rec.normal;</span><br><span class="line">			ni_over_nt = <span class="number">1.0</span> / ref_idx;</span><br><span class="line">			cosine = -<span class="built_in">dot</span>(r_in.<span class="built_in">direction</span>(), rec.normal) / r_in.<span class="built_in">direction</span>().<span class="built_in">length</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">refract</span>(r_in.<span class="built_in">direction</span>(), outward_normal, ni_over_nt, refracted)) &#123;</span><br><span class="line">			<span class="comment">//scattered = ray(rec.p, refracted);</span></span><br><span class="line">			reflect_prob = <span class="built_in">schlick</span>(cosine, ref_idx);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			scattered = <span class="built_in">ray</span>(rec.p, reflected);</span><br><span class="line">			reflect_prob = <span class="number">1.0</span>;</span><br><span class="line">			<span class="comment">//return false;</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 随机数小与反射系数，设为反射光线，反之为折射光线</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">drand48</span>() &lt; reflect_prob) &#123;</span><br><span class="line">			scattered = <span class="built_in">ray</span>(rec.p, reflected);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			scattered = <span class="built_in">ray</span>(rec.p, refracted);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> ref_idx;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/" rel="tag"># 计算机图形学</a>
              <a href="/tags/%E5%85%89%E7%BA%BF%E8%BF%BD%E8%B8%AA/" rel="tag"># 光线追踪</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/blog/2022/02/11/hello-world/" rel="prev" title="Hello World">
      <i class="fa fa-chevron-left"></i> Hello World
    </a></div>
      <div class="post-nav-item">
    <a href="/blog/2023/02/11/pictest/" rel="next" title="Pictest">
      Pictest <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ray-tracing-in-one-week%E7%B3%BB%E5%88%97%E7%AC%94%E8%AE%B0"><span class="nav-number">1.</span> <span class="nav-text"> Ray Tracing in One Week系列笔记</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#chapter-1~2-output-an-image-and-vec3"><span class="nav-number">1.1.</span> <span class="nav-text"> Chapter 1~2 : Output an image and Vec3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#chapter-3-rays-a-simple-camera-and-background"><span class="nav-number">1.2.</span> <span class="nav-text"> Chapter 3 ：Rays, a simple camera, and background</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%84%E7%BA%BF%E7%9A%84%E6%9E%84%E5%BB%BA"><span class="nav-number">1.2.1.</span> <span class="nav-text"> 射线的构建</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#chapter-4-adding-a-sphere"><span class="nav-number">1.3.</span> <span class="nav-text"> Chapter 4 ：Adding a sphere</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#chapter-5-surface-normals-and-multiple-objects"><span class="nav-number">1.4.</span> <span class="nav-text"> Chapter 5 : Surface normals and multiple objects</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#chapter-6-antialiasing"><span class="nav-number">1.5.</span> <span class="nav-text"> Chapter 6 : Antialiasing</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#chapter7-diffuse-materials"><span class="nav-number">1.6.</span> <span class="nav-text"> Chapter7 : Diffuse Materials</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#chapter-8-metal"><span class="nav-number">1.7.</span> <span class="nav-text"> Chapter 8 : Metal</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#chapter9dielectrics"><span class="nav-number">1.8.</span> <span class="nav-text"> Chapter9:Dielectrics</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Uddoo"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Uddoo</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/uddoo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;uddoo" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ywli233@qq.com" title="E-Mail → mailto:ywli233@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://space.bilibili.com/3461572670261783" title="Bilibili → https:&#x2F;&#x2F;space.bilibili.com&#x2F;3461572670261783" rel="noopener" target="_blank"><i class="iconfont icon-bilibili-line fa-fw"></i></a>
      </span>
  </div>



      </div>

      <div class="twopeople">
                    <div class="container" style="height:200px;">
                        <canvas class="illo" width="800" height="800" style="max-width: 200px; max-height: 200px; touch-action: none; width: 640px; height: 640px;"></canvas>
                    </div>
                    <script src="https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/js/twopeople1.js"></script>
                    <script src="https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/js/zdog.dist.js"></script>
                    <script id="rendered-js" src="https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/js/twopeople.js"></script>
                    <style>
                        .twopeople{
                            margin: 0;
                            align-items: center;
                            justify-content: center;
                            text-align: center;
                        }
                        canvas {
                            display: block;
                            margin: 0 auto;
                            cursor: move;
                        }
                    </style>
            </div>

      <div class="cc-license animated" itemprop="sponsor">
        <a href="https://www.netlify.com" class="cc-opacity" title="Deploy with Netlify → https://www.netlify.com" target="_blank"><img width="80" src="https://www.netlify.com/img/global/badges/netlify-dark.svg" alt="Netlify"></a>
      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2022 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Uddoo</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">7k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">26 分钟</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/three-waves.min.js"></script>


  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  
      
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex@0/dist/katex.min.css">


  

</body>
</html>
